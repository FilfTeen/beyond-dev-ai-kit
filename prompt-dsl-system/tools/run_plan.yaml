run:
  pipeline: "prompt-dsl-system/04_ai_pipeline_orchestration/pipeline_kit_self_upgrade.md"
  context_id: "ctx-a4e3fd25fe91"
  trace_id: "trace-2bdc9916ec76415e940992a2e7961769"
  generated_at: "2026-02-12T08:20:06+00:00"
  effective_module_path: "/Users/dwight/Downloads/【洪智科技】本地存档/beyond-dev-ai-kit"
  module_path_source: "cli"
  profile:
    path: "prompt-dsl-system/company_profile.yaml"
    applied: true
    injected_defaults:
      execution_tool: "disql"
      require_precheck_gate: true
      schema_strategy: "login-default"
steps:
  - step: 1
    skill: "skill_governance_audit_kit_quality"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/governance/skill_governance_audit_kit_quality.yaml"
    parameters:
      context_id: "ctx-a4e3fd25fe91"
      trace_id: "trace-2bdc9916ec76415e940992a2e7961769"
      input_artifact_refs: []
      acceptance:
        - "A1_impact_tree.md"
        - "A1_kit_selfcheck_report.json"
        - "A1_kit_selfcheck_report.md"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "kit-only"
        - "no external business repo mutation"
        - "must output json + md reports"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止修改外部业务仓库"
        - "禁止跳过质量评分"
      mode: "governance"
      module_path: "{{allowed_module_root}}"
      objective: "运行 kit_selfcheck.py 输出质量评分与缺口列表；仅允许 kit 内路径写入报告。"
      repo_root: "{{repo_root}}"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A1_kit_selfcheck_report.json（来自上一步 artifacts）"
  - step: 2
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-a4e3fd25fe91"
      trace_id: "trace-2bdc9916ec76415e940992a2e7961769"
      input_artifact_refs:
        - "A1_kit_selfcheck_report.json"
      acceptance:
        - "A2_upgrade_backlog.md"
        - "A2_route_decision.md"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "must include tradeoff table"
        - "must keep kit-only scope"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止越界修改业务仓库"
        - "禁止无证据决策"
      mode: "meta"
      module_path: "{{allowed_module_root}}"
      objective: "基于 A1 报告输出优先级路线：P0/P1/P2 改进项、收益/风险/成本对比、建议执行顺序。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A2_upgrade_backlog.md（来自上一步 artifacts）"
  - step: 3
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-a4e3fd25fe91"
      trace_id: "trace-2bdc9916ec76415e940992a2e7961769"
      input_artifact_refs:
        - "A2_upgrade_backlog.md"
      acceptance:
        - "A3_change_ledger.md"
        - "A3_rollback_plan.md"
        - "A3_cleanup_report.md"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "kit-only writes"
        - "keep backward compatibility where possible"
        - "must update compliance/baseline when coverage changes"
        - "use closure templates: prompt-dsl-system/tools/artifacts/templates/kit_self_upgrade/"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止越界到外部业务仓库"
        - "禁止大范围无目标重构"
      mode: "meta"
      module_path: "{{allowed_module_root}}"
      objective: "按 A2 优先级实施最小侵入升级，仅修改 prompt/DSL/skill/pipeline/tooling 文档与脚本。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A3_change_ledger.md（来自上一步 artifacts）"
  - step: 4
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-a4e3fd25fe91"
      trace_id: "trace-2bdc9916ec76415e940992a2e7961769"
      input_artifact_refs:
        - "A3_change_ledger.md"
      acceptance:
        - "A4_validate_result.json"
        - "A4_release_notes.md"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "validate: ./prompt-dsl-system/tools/run.sh validate --repo-root ."
        - "strict self-upgrade gate: ./prompt-dsl-system/tools/run.sh self-upgrade --repo-root . --strict-self-upgrade"
        - "lint: /usr/bin/python3 prompt-dsl-system/tools/pipeline_contract_lint.py --repo-root . --fail-on-empty"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止跳过校验"
      mode: "docs"
      module_path: "{{allowed_module_root}}"
      objective: "执行 validate + lint + 收尾文档，确保升级可复现、可回滚、可审计。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "Final step."
