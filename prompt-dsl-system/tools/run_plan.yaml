run:
  pipeline: "prompt-dsl-system/04_ai_pipeline_orchestration/pipeline_module_migration.md"
  context_id: "ctx-07b98a5c8350"
  trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
  generated_at: "2026-02-11T01:38:09+00:00"
  effective_module_path: "/Users/dwight/Downloads/【洪智科技】本地存档/beyond-dev-ai-kit/prompt-dsl-system"
  module_path_source: "cli"
  profile:
    path: "prompt-dsl-system/company_profile.yaml"
    applied: true
    injected_defaults:
      execution_tool: "disql"
      require_precheck_gate: true
      schema_strategy: "login-default"
steps:
  - step: 1
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-07b98a5c8350"
      trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
      input_artifact_refs: []
      acceptance:
        - "A1_migration_plan.md (tree: objective → integration_point → skill name → action)"
        - "A1_impact_tree.md"
        - "if profile missing: A1_required_additional_information.md"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "scan-only"
        - "Layer1 (declared) MUST exist, otherwise output required_additional_information"
        - "Layer2 (discovered) optional: if missing, recommend running module_profile_scanner.py"
        - "merge precedence: Layer0 < Layer1 < Layer2 (discovery.* only)"
        - "discovered cannot override scope/objectives/identity"
        - "check skill name uniqueness against registry"
        - "decision order: reuse > extend > create"
        - "migration plan must map: objective → integration_point → skill"
      decision_policy: "{dependency_strategy_order: [\"reuse\", \"extend\", \"create\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止改 /sys,/error,/util,/vote"
        - "禁止臆测模块结构/字段/逻辑"
        - "禁止在此步骤创建或修改任何文件"
      mode: "governance"
      module_path: "{{allowed_module_root}}"
      objective: "按三层合并读取 Effective Profile：(1) Layer0 projects/{{project_key}}/profile.yaml；(2) Layer1 module_profiles/{{project_key}}/{{module_key}}.yaml（必须存在，否则输出 required_additional_information checklist）；(3) Layer2 module_profiles/{{project_key}}/{{module_key}}.discovered.yaml（若存在则加载索引，否则建议运行 module_profile_scanner.py）。合并后解析集成点和迁移目标；扫描 skills.json 评估可复用 skill；输出迁移计划树和影响分析。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A1（来自上一步 artifacts）"
  - step: 2
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-07b98a5c8350"
      trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
      input_artifact_refs:
        - "A1"
      acceptance:
        - "A2_skill_set_list.md (skill name → objective → integration_points)"
        - "A2_skill_yamls/ (directory with all generated YAMLs)"
        - "A2 all skills have status: staging"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "at least one skill per migration_objective"
        - "for sql_portability: must generate skill covering Oracle→MySQL+DM8 dual-stack"
        - "skill name: skill_<module_key>_<verb>_<object>"
        - "YAML must validate against SKILL_SPEC.md required schema"
        - "all new skills MUST have status: staging"
        - "output_contract must include summary/artifacts[]/risks[]/next_actions[]"
        - "if discovered profile exists: reference discovery.file_index in skill scope"
        - "if discovered profile missing: output read_refs + suggest running scanner"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止改 /sys,/error,/util,/vote"
        - "禁止臆测命名/字段/逻辑"
        - "禁止将新 skill 设为 status: deployed"
      mode: "meta"
      module_path: "{{allowed_module_root}}"
      objective: "基于 Step1 迁移计划，为模块 {{module_key}} 生成技能集合列表。每个迁移目标至少一个 skill。命名规范：skill_<module_key>_<verb>_<object>。所有 skill 默认 status=staging。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A1, A2（来自上一步 artifacts）"
  - step: 3
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-07b98a5c8350"
      trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
      input_artifact_refs:
        - "A1"
        - "A2"
      acceptance:
        - "A3_updated_skills_json (valid JSON, all new entries status=staging)"
        - "A3_registry_diff.md (before/after)"
        - "Step3 checks: ✓ directories exist, ✓ no placeholders, ✓ references/scripts/assets subdirs"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "registry entry: name/description/version/domain/tags/path/status"
        - "all new entries MUST have status: staging"
        - "path must be repository-relative"
        - "no duplicate names in registry"
        - "no residual {{PLACEHOLDER}} in generated YAMLs"
        - "if materialize_skills=false: output dry-run skeleton list only, do NOT create files"
        - "if materialize_skills=true: copy templates, fill YAMLs, update skills.json"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止改 /sys,/error,/util,/vote"
        - "禁止删除现有 registry 条目"
        - "禁止将新 skill status 设为 deployed"
      mode: "meta"
      module_path: "{{allowed_module_root}}"
      objective: "为 Step2 产出的每个 skill：(1) 复制 templates/skill_template/ → skills/<domain>/skill_<name>/；(2) 填充 YAML（无 placeholder 残留）；(3) 注册到 skills.json（status=staging）。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A2, A3（来自上一步 artifacts）"
  - step: 4
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-07b98a5c8350"
      trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
      input_artifact_refs:
        - "A2"
        - "A3"
      acceptance:
        - "A4_pipelines/ (all generated pipeline files)"
        - "A4_pipeline_checklist.md"
        - "if discovered profile exists: pipelines must reference discovery.navindex for read_refs"
        - "if discovered profile missing: pipeline steps must include scanner run suggestion"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "pipeline must reference the corresponding skill by name"
        - "each step must include: context_id/trace_id/mode/objective/constraints/acceptance/forbidden/boundary_policy"
        - "at least 3 steps per pipeline"
        - "naming: pipeline_<module_key>_<verb>_<object>.md"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止改 /sys,/error,/util,/vote"
        - "禁止修改现有 pipeline 文件"
      mode: "meta"
      module_path: "{{allowed_module_root}}"
      objective: "为 Step2/3 产出的每个 skill 生成一个 pipeline_*.md 示例文件。命名：pipeline_<module_key>_<verb>_<object>.md。每个 pipeline 至少 3 步：scan → execute → closure。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A3, A4（来自上一步 artifacts）"
  - step: 5
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-07b98a5c8350"
      trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
      input_artifact_refs:
        - "A3"
        - "A4"
      acceptance:
        - "A5_validate_result.json (Errors=0)"
        - "A5_audit_result (PASS)"
        - "A5_lint_result (PASS)"
        - "if materialize_skills=true: audit(scope=staging) must PASS"
        - "mandatory closure artifacts: impact_tree, change_ledger, rollback_plan, cleanup_report"
        - "FACT_BASELINE.md updated (skill/pipeline counts)"
        - "COMPLIANCE_MATRIX.md updated (if new coverage)"
        - "skills.json status (mandatory declaration):"
        - "  skills.json updated = true, new entry count = N, all status = staging"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "closure mandatory"
        - "validate: HONGZHI_VALIDATE_STRICT=1 ./prompt-dsl-system/tools/run.sh validate --repo-root ."
        - "audit: /usr/bin/python3 prompt-dsl-system/tools/skill_template_audit.py --repo-root . --scope all --fail-on-empty"
        - "lint: /usr/bin/python3 prompt-dsl-system/tools/pipeline_contract_lint.py --repo-root . --fail-on-empty"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止跳过 validate/audit/lint"
      mode: "docs"
      module_path: "{{allowed_module_root}}"
      objective: "运行 validate(strict) + audit(scope=all) + lint 校验所有新增 skill/registry/pipeline 的完整性；产出收尾包。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "来自下一步引用：A5（来自上一步 artifacts）"
  - step: 6
    skill: "skill_hongzhi_universal_ops"
    skill_path: "prompt-dsl-system/05_skill_registry/skills/universal/skill_hongzhi_universal_ops.yaml"
    parameters:
      context_id: "ctx-07b98a5c8350"
      trace_id: "trace-26cbf701c6894a00ad17cbae11ea5262"
      input_artifact_refs:
        - "A5"
      acceptance:
        - "A6_promote_suggestions.md (skill → audit_pass → lint_pass → recommend: yes/no)"
      allowed_module_root: "{{allowed_module_root}}"
      boundary_policy: "allowed_module_root: \"{{allowed_module_root}}\"\nforbidden_paths: [\"/sys\", \"/error\", \"/util\", \"/vote\"]\nmax_change_scope: \"minimal\""
      constraints:
        - "scan-only, no modifications"
        - "list each staging skill with audit/lint status"
        - "do NOT auto-promote"
      decision_policy: "{dependency_strategy_order: [\"compat\", \"self-contained\", \"minimal-invasive\"], choose_best_route_with_tradeoff: true}"
      execution_tool: "disql"
      fact_policy: "{require_scan_before_change: true, unknown_requires_user: true}"
      forbidden:
        - "禁止自动修改 skills.json status"
        - "禁止跳过 audit/lint 检查"
      mode: "docs"
      module_path: "{{allowed_module_root}}"
      objective: "列出所有 staging skill 的 promote 建议：哪些已通过 audit+lint 可晋级，哪些需补充。不自动 promote，仅输出建议列表。用户可使用 pipeline_skill_promote.md 逐个晋级。"
      require_precheck_gate: true
      schema_strategy: "login-default"
      self_monitor_policy: "{loop_detection: true, auto_rollback_on_loop: true}"
      sql_policy: "{prefer_portable_sql: true, dual_sql_when_needed: [\"oracle\", \"mysql\"]}"
    expects:
      artifacts:
        - "A1"
        - "A2"
      notes: "Artifacts must be numbered A1/A2/... per SKILL_SPEC."
    handoff: "Final step."
